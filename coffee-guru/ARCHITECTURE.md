# 咖啡大师 - 系统架构设计

本文档详细描述了咖啡大师应用的架构设计、数据流转和层级关系。

## MVVM架构

项目采用MVVM（Model-View-ViewModel）架构，结合SwiftUI和Combine实现响应式数据流。

```
+-------------------------------------------------------------------+
|                                                                   |
|  +---------------------+        +--------------------------+      |
|  |                     |        |                          |      |
|  |    视图层 (View)      |        |      视图模型层 (ViewModel) |      |
|  |                     |        |                          |      |
|  |  +---------------+  |        |  +-------------------+   |      |
|  |  |               |  |        |  |                   |   |      |
|  |  |  SwiftUI Views |<---------+->| @ObservedObject   |   |      |
|  |  |               |  |  绑定   |  | @Published properties|      |
|  |  +---------------+  |        |  +-------------------+   |      |
|  |                     |        |           ^              |      |
|  |  +---------------+  |        |           |              |      |
|  |  |               |  |        |           |              |      |
|  |  | 可重用组件      |  |        |           |              |      |
|  |  | Components    |  |        |           | 直接使用       |      |
|  |  |               |  |        |           |              |      |
|  |  +---------------+  |        |           v              |      |
|  |                     |        |  +-------------------+   |      |
|  +---------------------+        |  |                   |   |      |
|                                 |  |    模型层 (Model)   |   |      |
|                                 |  |                   |   |      |
|                                 |  +--------^----------+   |      |
|                                          |                        |
|                                          | 数据转换                |
|                                          |                        |
|  +-----------------------------------------------------+          |
|  |                                                     |          |
|  |                  服务层 (Service)                    |          |
|  |                                                     |          |
|  |  +-------------------------+  +------------------+  |          |
|  |  |                         |  |                  |  |          |
|  |  | 网络请求                 |  | 网络状态管理       |  |          |
|  |  | ZhipuAPIService         |  | ZhipuNetworkManager |          |
|  |  |                         |  |                  |  |          |
|  |  +-------------------------+  +------------------+  |          |
|  |                                                     |          |
|  |  +-------------------------+  +------------------+  |          |
|  |  |                         |  |                  |  |          |
|  |  | 数据存储                 |  | 预加载服务        |  |          |
|  |  | CoffeeDataStore         |  | CoffeePreloadService |         |
|  |  |                         |  |                  |  |          |
|  |  +-------------------------+  +------------------+  |          |
|  |                                                     |          |
|  +-----------------------------------------------------+          |
|                                                                   |
+-------------------------------------------------------------------+
```

## 各层职责

### 1. 视图层 (View)
- 负责界面展示和用户交互
- 包含SwiftUI视图和可重用组件
- 位于`Views/`和`Components/`目录
- 使用`@ObservedObject`观察ViewModel状态变化
- 示例：`HomeView.swift`, `CoffeeCardView.swift`

### 2. 视图模型层 (ViewModel)
- 管理视图状态和业务逻辑
- 通过`@Published`属性和Combine发布者提供数据流
- 处理用户操作和更新模型
- 协调各种服务之间的交互
- 位于`Models/`目录下的独立文件
- 示例：`HomeViewModel.swift`

### 3. 模型层 (Model)
- 定义数据结构和领域模型
- 封装业务数据和规则
- 位于`Models/`目录
- 示例：`CoffeeItem`, `CoffeeDetail`

### 4. 服务层 (Service)
- 处理网络请求、数据持久化等底层操作
- 提供异步API调用和数据处理
- 转换原始数据为模型对象
- 位于`Services/`目录
- 包含多个专门的服务类：
  - `ZhipuAPIService`: 处理智谱API请求
  - `ZhipuNetworkManager`: 管理网络连接状态
  - `ZhipuResponseParser`: 解析API响应
  - `CoffeeDataStore`: 管理咖啡数据的本地存储
  - `CoffeePreloadService`: 处理咖啡详情的预加载逻辑

## 数据流向

### 数据获取流
1. 视图层请求ViewModel加载数据
2. ViewModel调用服务层的API方法
3. 服务层从智谱API获取原始数据
4. 服务层将原始数据转换为模型对象
5. ViewModel接收并处理模型对象
6. 视图层通过绑定自动更新UI

### 用户操作流
1. 视图层捕获用户事件（如滚动到底部）
2. 视图层调用ViewModel的方法（如loadMoreCoffee）
3. ViewModel处理操作逻辑
4. ViewModel调用服务层或更新模型
5. 更新后的数据通过@Published属性自动通知视图层
6. 视图层基于新状态重新渲染

### 预加载流程
1. 视图层检测到卡片出现在视图中
2. 视图层通知ViewModel卡片可见性变化
3. ViewModel将可见性信息传递给CoffeePreloadService
4. CoffeePreloadService在滚动稳定后触发预加载
5. CoffeePreloadService调用ZhipuAPIService获取详情数据
6. 预加载的数据存储在CoffeePreloadService中
7. 用户点击卡片时，ViewModel从CoffeePreloadService获取预加载的详情

## 设计优势

- **关注点分离**: 各层职责明确，便于团队协作和代码维护
- **可测试性**: 业务逻辑与UI分离，便于单元测试
- **响应式**: 利用Combine和SwiftUI的响应式特性，实现状态驱动的UI更新
- **可扩展性**: 模块化设计使得添加新功能更加便捷
- **内存管理**: 使用weak self和proper cancellation防止内存泄漏
- **单一职责**: 每个服务类专注于特定功能，提高代码可维护性
- **性能优化**: 通过预加载和缓存机制提升用户体验
